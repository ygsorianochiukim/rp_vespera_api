name: Deploy to Staging

on:
  push:
    branches:
      - develop

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Deploy to OVH Staging
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.STAGING_HOST }}
          username: ${{ secrets.STAGING_USER }}
          key: ${{ secrets.STAGING_SSH_KEY }}
          script: |
            set -e
            echo "üöÄ Starting STAGING deployment..."

            # Clone if missing
            if [ ! -d /var/www/staging/.git ]; then
              rm -rf /var/www/staging
              git clone https://github.com/rp-vespera/rp_vespera_api.git /var/www/staging
            fi

            cd /var/www/staging

            # Reset to develop
            git fetch origin
            git checkout develop
            git reset --hard origin/develop
            git clean -fd

            echo "üì¶ Installing dependencies..."
            composer install --no-interaction --prefer-dist --optimize-autoloader

            echo "‚öôÔ∏è Preparing environment..."
            if [ ! -f .env ]; then
              cp .env.example .env
            fi

            # ==========================
            # PRIMARY DATABASE (DB1)
            # ==========================
            export APP_URL="${{ secrets.STAGING_APP_URL }}"
            export DB_HOST="${{ secrets.STAGING_DB_HOST }}"
            export DB_PORT="${{ secrets.STAGING_DB_PORT }}"
            export DB_DATABASE="${{ secrets.STAGING_DB_NAME }}"
            export DB_USERNAME="${{ secrets.STAGING_USERNAME }}"
            export DB_PASSWORD="${{ secrets.STAGING_PASSWORD }}"

            # ==========================
            # SECONDARY DATABASE (DB2)
            # (NO MIGRATIONS)
            # ==========================
            export DB2_HOST="${{ secrets.STAGING_DB2_HOST }}"
            export DB2_PORT="${{ secrets.STAGING_DB2_PORT }}"
            export DB2_DATABASE="${{ secrets.STAGING_DB2_NAME }}"
            export DB2_USERNAME="${{ secrets.STAGING_DB2_USERNAME }}"
            export DB2_PASSWORD="${{ secrets.STAGING_DB2_PASSWORD }}"

            # Update .env safely
            sed -i "s|^APP_ENV=.*|APP_ENV=staging|" .env
            sed -i "s|^APP_DEBUG=.*|APP_DEBUG=false|" .env
            sed -i "s|^APP_URL=.*|APP_URL=${APP_URL}|" .env

            sed -i "s|^DB_HOST=.*|DB_HOST=${DB_HOST}|" .env
            sed -i "s|^DB_PORT=.*|DB_PORT=${DB_PORT}|" .env
            sed -i "s|^DB_DATABASE=.*|DB_DATABASE=${DB_DATABASE}|" .env
            sed -i "s|^DB_USERNAME=.*|DB_USERNAME=${DB_USERNAME}|" .env
            sed -i "s|^DB_PASSWORD=.*|DB_PASSWORD=${DB_PASSWORD}|" .env

            sed -i "s|^DB2_HOST=.*|DB2_HOST=${DB2_HOST}|" .env
            sed -i "s|^DB2_PORT=.*|DB2_PORT=${DB2_PORT}|" .env
            sed -i "s|^DB2_DATABASE=.*|DB2_DATABASE=${DB2_DATABASE}|" .env
            sed -i "s|^DB2_USERNAME=.*|DB2_USERNAME=${DB2_USERNAME}|" .env
            sed -i "s|^DB2_PASSWORD=.*|DB2_PASSWORD=${DB2_PASSWORD}|" .env

            echo "üîë Ensuring APP_KEY exists..."
            if ! grep -q "^APP_KEY=" .env || grep -q "^APP_KEY=$" .env; then
              php artisan key:generate
            fi

            echo "üßπ Clearing & caching config..."
            php artisan config:clear
            php artisan config:cache

            echo "üóÑÔ∏è Running migrations (PRIMARY DB ONLY)..."
            php artisan migrate --force

            echo "‚ö° Optimizing application..."
            php artisan optimize

            echo "‚úÖ STAGING deployment finished successfully!"
