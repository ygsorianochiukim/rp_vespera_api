name: Deploy to Production

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Deploy to OVH Production
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.PRODUCTION_HOST }}
          username: ${{ secrets.PRODUCTION_USER }}
          key: ${{ secrets.PRODUCTION_SSH_KEY }}
          script: |
            set -e
            echo "üöÄ Starting PRODUCTION deployment..."

            APP_PATH="/var/www/production"

            # ==========================
            # FIRST-TIME CLONE
            # ==========================
            if [ ! -d "$APP_PATH/.git" ]; then
              echo "üì• Cloning repository..."
              rm -rf $APP_PATH
              git clone https://github.com/rp-vespera/rp_vespera_api.git $APP_PATH
            fi

            cd $APP_PATH

            echo "üîÑ Syncing main branch..."
            git fetch origin
            git checkout main
            git reset --hard origin/main
            git clean -fd

            echo "üì¶ Installing dependencies (production)..."
            composer install \
              --no-dev \
              --no-interaction \
              --prefer-dist \
              --optimize-autoloader

            echo "‚öôÔ∏è Preparing environment..."
            if [ ! -f .env ]; then
              cp .env.example .env
            fi

            # ==========================
            # APPLICATION
            # ==========================
            export APP_URL="${{ secrets.PRODUCTION_APP_URL }}"

            sed -i "s|^APP_ENV=.*|APP_ENV=production|" .env
            sed -i "s|^APP_DEBUG=.*|APP_DEBUG=false|" .env
            sed -i "s|^APP_URL=.*|APP_URL=${APP_URL}|" .env

            # ==========================
            # PRIMARY DATABASE (DB1)
            # ==========================
            export DB_HOST="${{ secrets.PRODUCTION_HOST }}"
            export DB_PORT="${{ secrets.PRODUCTION_DB_PORT }}"
            export DB_USERNAME="${{ secrets.PRODUCTION_USERNAME }}"
            export DB_PASSWORD="${{ secrets.PRODUCTION_PASSWORD }}"

            sed -i "s|^DB_CONNECTION=.*|DB_CONNECTION=mysql|" .env
            sed -i "s|^DB_HOST=.*|DB_HOST=${DB_HOST}|" .env
            sed -i "s|^DB_PORT=.*|DB_PORT=${DB_PORT}|" .env
            sed -i "s|^DB_USERNAME=.*|DB_USERNAME=${DB_USERNAME}|" .env
            sed -i "s|^DB_PASSWORD=.*|DB_PASSWORD=\"${DB_PASSWORD}\"|" .env

            # ==========================
            # SECONDARY DATABASE (DB2)
            # READ-ONLY / REFERENCE
            # ==========================
            export DB2_HOST="${{ secrets.PRODUCTION_HOST }}"
            export DB2_PORT="${{ secrets.PRODUCTION_DB_PORT2 }}"
            export DB2_USERNAME="${{ secrets.PRODUCTION_USERNAME }}"
            export DB2_PASSWORD="${{ secrets.PRODUCTION_PASSWORD }}"

            echo "‚öôÔ∏è Writing DB2 credentials..."

            grep -q "^DB2_HOST=" .env \
              && sed -i "s|^DB2_HOST=.*|DB2_HOST=${DB2_HOST}|" .env \
              || echo "DB2_HOST=${DB2_HOST}" >> .env

            grep -q "^DB2_PORT=" .env \
              && sed -i "s|^DB2_PORT=.*|DB2_PORT=${DB2_PORT}|" .env \
              || echo "DB2_PORT=${DB2_PORT}" >> .env

            grep -q "^DB2_USERNAME=" .env \
              && sed -i "s|^DB2_USERNAME=.*|DB2_USERNAME=${DB2_USERNAME}|" .env \
              || echo "DB2_USERNAME=${DB2_USERNAME}" >> .env

            grep -q "^DB2_PASSWORD=" .env \
              && sed -i "s|^DB2_PASSWORD=.*|DB2_PASSWORD=\"${DB2_PASSWORD}\"|" .env \
              || echo "DB2_PASSWORD=\"${DB2_PASSWORD}\"" >> .env

            # ==========================
            # PRODUCTION-SAFE DRIVERS
            # ==========================
            sed -i "s|^SESSION_DRIVER=.*|SESSION_DRIVER=file|" .env
            sed -i "s|^CACHE_STORE=.*|CACHE_STORE=file|" .env
            sed -i "s|^QUEUE_CONNECTION=.*|QUEUE_CONNECTION=sync|" .env

            echo "üîë Ensuring APP_KEY exists..."
            if ! grep -q "^APP_KEY=base64:" .env; then
              php artisan key:generate --force
            fi

            echo "üßπ Clearing caches..."
            php artisan optimize:clear
            rm -f bootstrap/cache/*.php

            echo "üóÑÔ∏è Running migrations (PRIMARY DB ONLY)..."
            php artisan migrate --force

            echo "üîê Fixing permissions..."
            chmod -R ug+rwX storage bootstrap/cache

            echo "‚ö° Rebuilding caches..."
            php artisan config:cache
            php artisan route:cache
            php artisan view:cache

            echo "‚úÖ PRODUCTION deployment finished successfully!"
